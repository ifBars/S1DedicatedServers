name: Build Documentation

on:
  push:
    branches: [ main, stable ]
  pull_request:
    branches: [ main, stable ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "docs"
  cancel-in-progress: false

jobs:
  build-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout DedicatedServerMod
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Determine Assembly Branch
        id: assembly-branch
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]] && [[ "${{ contains(github.event.pull_request.labels.*.name, 'beta') }}" == "true" ]]; then
            echo "branch=beta" >> $GITHUB_OUTPUT
            echo "Using beta assemblies"
          else
            echo "branch=main" >> $GITHUB_OUTPUT
            echo "Using main assemblies"
          fi

      - name: Create Assembly Directory Structure
        run: |
          mkdir -p DedicatedServerMod/ScheduleOneAssemblies/Managed
          mkdir -p DedicatedServerMod/ScheduleOneAssemblies/MelonLoader

      - name: Restore Game Assemblies from Cache
        id: cache-assemblies
        uses: actions/cache/restore@v4
        with:
          path: DedicatedServerMod/ScheduleOneAssemblies
          key: docs-game-assemblies-v1-${{ steps.assembly-branch.outputs.branch }}
          restore-keys: |
            docs-game-assemblies-v1-${{ steps.assembly-branch.outputs.branch }}-

      - name: Checkout Game Assemblies
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.GAME_ASSEMBLIES_REPO }}
          token: ${{ secrets.GAME_ASSEMBLIES_TOKEN }}
          ref: ${{ steps.assembly-branch.outputs.branch }}
          path: game-assemblies
          fetch-depth: 1
        if: steps.cache-assemblies.outputs.cache-hit != 'true' && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository)

      - name: Copy Game Assemblies
        run: |
          if [ -d "game-assemblies/Managed" ]; then
            cp -r game-assemblies/Managed/* DedicatedServerMod/ScheduleOneAssemblies/Managed/ || echo "Failed to copy assemblies"
            echo "Copied game assemblies"
          fi
        if: steps.cache-assemblies.outputs.cache-hit != 'true' && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository)

      - name: Create CI Build Properties
        run: |
          cat > ci.build.props << 'EOF'
          <Project>
              <PropertyGroup>
                  <AutomateLocalDeployment>false</AutomateLocalDeployment>
                  <MelonLoaderAssembliesPath>$(MSBuildThisFileDirectory)DedicatedServerMod/ScheduleOneAssemblies/MelonLoader</MelonLoaderAssembliesPath>
                  <MonoAssembliesPath>$(MSBuildThisFileDirectory)DedicatedServerMod/ScheduleOneAssemblies/Managed</MonoAssembliesPath>
              </PropertyGroup>
          </Project>
          EOF

      - name: Install DocFX
        run: dotnet tool install -g docfx

      - name: Build Documentation
        run: |
          cd DedicatedServerMod
          docfx docfx.json

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./DedicatedServerMod/_site
        if: github.event_name != 'pull_request'

      - name: Save Game Assemblies to Cache
        uses: actions/cache/save@v4
        if: always() && steps.cache-assemblies.outputs.cache-hit != 'true'
        with:
          path: DedicatedServerMod/ScheduleOneAssemblies
          key: docs-game-assemblies-v1-${{ steps.assembly-branch.outputs.branch }}

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-docs
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/stable'
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
